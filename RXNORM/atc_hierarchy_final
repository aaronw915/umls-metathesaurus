CREATE OR REPLACE TABLE ATC_HIERARCHY_FLAT AS

WITH ALLPATHS AS (
    -- SELECT ALL RELEVANT ATC CODES FROM MRHIER
    SELECT 
        MRH.CUI AS TARGET_CUI,
        MRH.AUI AS CHILD_AUI,
        MRH.PTR || '.' || MRH.AUI AS FULL_PATH_STRING
    FROM 
        MRHIER MRH
    WHERE 
        MRH.SAB = 'ATC'
),
SPLITALLPATHS AS (
    -- USE SPLIT_TO_TABLE TO EXPLODE ALL PATHS INTO INDIVIDUAL ROWS
    SELECT 
        AP.TARGET_CUI,
        AP.CHILD_AUI, -- KEEP THE ORIGINAL CHILD AUI HANDY
        S.SEQ AS HIERARCHY_SEQ,
        S.VALUE::STRING AS PATH_AUI
    FROM 
        ALLPATHS AP,
        TABLE(SPLIT_TO_TABLE(AP.FULL_PATH_STRING, '.')) AS S
)
-- JOIN BACK TO MRCONSO TO GET DETAILS AND DETERMINE LEVEL USING CODE LENGTH
SELECT 
    SP.TARGET_CUI AS CUI,
    MC_LEAF.CODE AS TARGET_ATC_CODE_LEAF, -- *** ADDED THIS COLUMN ***
    SP.PATH_AUI AS AUI,
    MC_ANCESTOR.CODE AS ATC_CODE,
    MC_ANCESTOR.STR AS ATC_NAME,
    CASE 
        WHEN LENGTH(MC_ANCESTOR.CODE) = 1 THEN 1
        WHEN LENGTH(MC_ANCESTOR.CODE) = 3 THEN 2
        WHEN LENGTH(MC_ANCESTOR.CODE) = 4 THEN 3
        WHEN LENGTH(MC_ANCESTOR.CODE) = 5 THEN 4
        WHEN LENGTH(MC_ANCESTOR.CODE) = 7 THEN 5
        ELSE 99
    END AS HIERARCHY_LEVEL
FROM 
    SPLITALLPATHS SP
JOIN 
    MRCONSO MC_ANCESTOR ON SP.PATH_AUI = MC_ANCESTOR.AUI AND MC_ANCESTOR.SAB = 'ATC'
JOIN
    MRCONSO MC_LEAF ON SP.CHILD_AUI = MC_LEAF.AUI AND MC_LEAF.SAB = 'ATC';

    select * from atc_hierarchy_flat where target_atc_code_leaf = 'A10BJ06';
